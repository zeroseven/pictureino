var __defProp=Object.defineProperty,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__publicField=(e,t,i)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,i);class Observer{constructor(e){__publicField(this,"element"),__publicField(this,"resizeObserver",null),__publicField(this,"intersectionObserver",null),__publicField(this,"resizeTimeout",null),this.element=e}onResize(i,s){var e;null!=(e=this.resizeObserver)&&e.disconnect(),this.resizeObserver=new ResizeObserver(e=>{this.resizeTimeout&&window.clearTimeout(this.resizeTimeout);let t=e[0];this.resizeTimeout=window.setTimeout(()=>{var e;s&&Math.abs(s.width-t.contentRect.width)/s.width<=.02&&Math.abs(s.height-t.contentRect.height)/s.height<=.02||(null!=(e=this.resizeObserver)&&e.disconnect(),"function"==typeof i&&i({width:t.contentRect.width,height:t.contentRect.height},this))},150)}),this.resizeObserver.observe(this.element)}inView(t){var e;null!=(e=this.intersectionObserver)&&e.disconnect(),this.intersectionObserver=new IntersectionObserver(e=>{e[0].isIntersecting&&(t(this),null!=(e=this.intersectionObserver))&&e.disconnect()},{threshold:.1,rootMargin:"0px"}),this.intersectionObserver.observe(this.element)}disconnect(){var e;this.resizeTimeout&&(window.clearTimeout(this.resizeTimeout),this.resizeTimeout=null),null!=(e=this.resizeObserver)&&e.disconnect(),null!=(e=this.intersectionObserver)&&e.disconnect()}}class Loader{requestImage(e){return fetch(e).then(async e=>{var t=await e.json();return e.ok?t:t.error?Promise.reject(t.error):Promise.reject({error:{message:e.statusText,code:e.status}})})}}let webpSupport=new Promise(e=>{let t=new Image;t.onload=()=>e(0<t.width&&0<t.height),t.onerror=()=>e(!1),t.src="data:image/webp;base64,UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA=="});class PictureinoWrap extends HTMLElement{constructor(){super(),__publicField(this,"image"),__publicField(this,"config"),__publicField(this,"observer"),__publicField(this,"loader"),__publicField(this,"sources"),__publicField(this,"size"),this.updateSource=this.updateSource.bind(this)}async getRequestUri(){var e=await webpSupport?"webp/":"",t=parseInt(this.size.width.toString(),10),i=parseInt(this.size.height.toString(),10);return`/-/pictureino/img/${Math.round(window.innerWidth)}${1<window.devicePixelRatio?2:1}x${this.config}/${e}${t}x${i}/`}updateImage(e){this.image.width=e.processed.width,this.image.height=e.processed.height,e.processed.img1x&&(this.image.src=e.processed.img1x),e.processed.img2x?(this.image.src=e.processed.img2x,this.image.srcset=e.processed.img2x+" 2x"):this.image.removeAttribute("srcset")}updateSourceTag(e,t){e=this.sources[e];e&&(e.width=t.processed.width,e.height=t.processed.height,t.processed.img1x&&(e.srcset=t.processed.img1x),t.processed.img2x)&&(e.srcset=t.processed.img2x+" 2x")}getSourceKey(t){var e=Object.keys(this.sources).map(Number);return e.length&&(e=e.filter(e=>e<=t)).length?Math.max(...e):0}updateSource(){let i=()=>{delete this.dataset.loading,this.observer.onResize(e=>{this.size=e,this.updateSource()},this.size)};if(this.size.width<=50||this.size.height<=0)return i();this.dataset.loading="",this.getRequestUri().then(e=>{this.loader.requestImage(e).then(e=>{var t=this.getSourceKey(e.view);t?this.updateSourceTag(t,e):this.updateImage(e),this.image.addEventListener("load",i,{once:!0})}).catch(e=>{console.info("Pictureino error (retry after 1s)",e),setTimeout(i,1e3)})})}collectSources(){var e=this.image.closest("picture");e&&Array.from(e.getElementsByTagName("source")).forEach(e=>{var t=e.getAttribute("media"),t=null==t?void 0:t.match(/\d+/),t=t?parseInt(t[0],10):null;t&&(this.sources[t]=e)})}init(e,t){this.image=e,this.config=t,this.observer=new Observer(this),this.loader=new Loader,this.sources={},this.size={width:e.offsetWidth,height:e.offsetHeight},this.dataset.loading="",delete this.dataset.config,this.collectSources(),this.observer.inView(this.updateSource)}connectedCallback(){var e=this.getElementsByTagName("img"),t=this.getAttribute("data-config")||"";1===e.length&&t?this.init(e[0],t):console.warn('PictureinoWrap: Invalid configuration. Expected one <img> element and a "data-config" attribute.')}disconnectedCallback(){this.observer&&this.observer.disconnect()}}customElements.define("pictureino-wrap",PictureinoWrap);